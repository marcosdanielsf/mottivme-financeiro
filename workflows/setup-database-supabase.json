{
  "name": "üóÑÔ∏è Setup Database Luna Financeiro",
  "nodes": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ========================================\n-- SCHEMA POSTGRESQL - LUNA FINANCEIRO\n-- Arquitetura H√≠brida: PostgreSQL + Airtable\n-- ========================================\n\n-- Extens√µes necess√°rias\nCREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";\nCREATE EXTENSION IF NOT EXISTS \"pg_trgm\"; -- Para full-text search\n\n-- Schema principal\nCREATE SCHEMA IF NOT EXISTS luna_financeiro;\n\n-- ========================================\n-- ENUMS (Tipos Personalizados)\n-- ========================================\n\nCREATE TYPE luna_financeiro.tipo_documento AS ENUM (\n    'contas_pagar',\n    'contas_receber'\n);\n\nCREATE TYPE luna_financeiro.status_documento AS ENUM (\n    'pendente',\n    'aprovado',\n    'rejeitado',\n    'pago',\n    'recebido',\n    'cancelado',\n    'vencido'\n);\n\nCREATE TYPE luna_financeiro.tipo_pagamento AS ENUM (\n    'recorrente_mensal',\n    'recorrente_anual',\n    'pagamento_unico'\n);\n\nCREATE TYPE luna_financeiro.tipo_entidade AS ENUM (\n    'fornecedor',\n    'cliente'\n);\n\nCREATE TYPE luna_financeiro.forma_pagamento AS ENUM (\n    'pix',\n    'ted',\n    'doc',\n    'boleto',\n    'cartao_credito',\n    'cartao_debito',\n    'dinheiro',\n    'cheque'\n);\n\n-- ========================================\n-- TABELA: Entidades (Fornecedores/Clientes)\n-- ========================================\n\nCREATE TABLE IF NOT EXISTS luna_financeiro.entidades (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    tipo luna_financeiro.tipo_entidade NOT NULL,\n    nome VARCHAR(255) NOT NULL,\n    nome_fantasia VARCHAR(255),\n    cnpj_cpf VARCHAR(18) UNIQUE,\n    email VARCHAR(255),\n    telefone VARCHAR(20),\n    whatsapp VARCHAR(20),\n\n    -- Endere√ßo\n    cep VARCHAR(9),\n    logradouro VARCHAR(255),\n    numero VARCHAR(20),\n    complemento VARCHAR(100),\n    bairro VARCHAR(100),\n    cidade VARCHAR(100),\n    estado VARCHAR(2),\n\n    -- Dados banc√°rios\n    banco VARCHAR(100),\n    agencia VARCHAR(20),\n    conta VARCHAR(30),\n    tipo_conta VARCHAR(20),\n    pix_key VARCHAR(255),\n\n    -- Gest√£o\n    ativo BOOLEAN DEFAULT TRUE,\n    score INTEGER DEFAULT 50,\n    observacoes TEXT,\n\n    -- Sincroniza√ß√£o Airtable\n    airtable_record_id VARCHAR(50) UNIQUE,\n\n    -- Auditoria\n    created_at TIMESTAMP DEFAULT NOW(),\n    updated_at TIMESTAMP DEFAULT NOW(),\n    created_by VARCHAR(100),\n    updated_by VARCHAR(100),\n\n    -- √çndices\n    CONSTRAINT chk_cnpj_cpf_format CHECK (\n        cnpj_cpf IS NULL OR\n        cnpj_cpf ~ '^[0-9]{3}\\.[0-9]{3}\\.[0-9]{3}-[0-9]{2}$' OR\n        cnpj_cpf ~ '^[0-9]{2}\\.[0-9]{3}\\.[0-9]{3}/[0-9]{4}-[0-9]{2}$'\n    )\n);\n\nCREATE INDEX IF NOT EXISTS idx_entidades_tipo ON luna_financeiro.entidades(tipo);\nCREATE INDEX IF NOT EXISTS idx_entidades_cnpj_cpf ON luna_financeiro.entidades(cnpj_cpf);\nCREATE INDEX IF NOT EXISTS idx_entidades_nome ON luna_financeiro.entidades USING gin(nome gin_trgm_ops);\nCREATE INDEX IF NOT EXISTS idx_entidades_airtable ON luna_financeiro.entidades(airtable_record_id);\n\n-- ========================================\n-- TABELA: Categorias\n-- ========================================\n\nCREATE TABLE IF NOT EXISTS luna_financeiro.categorias (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    nome VARCHAR(100) NOT NULL UNIQUE,\n    descricao TEXT,\n    tipo luna_financeiro.tipo_documento NOT NULL,\n    cor VARCHAR(7),\n    icone VARCHAR(50),\n    parent_id UUID REFERENCES luna_financeiro.categorias(id),\n\n    -- Or√ßamento\n    orcamento_mensal DECIMAL(15, 2),\n\n    -- Sincroniza√ß√£o\n    airtable_record_id VARCHAR(50) UNIQUE,\n\n    -- Auditoria\n    created_at TIMESTAMP DEFAULT NOW(),\n    updated_at TIMESTAMP DEFAULT NOW()\n);\n\nCREATE INDEX IF NOT EXISTS idx_categorias_tipo ON luna_financeiro.categorias(tipo);\nCREATE INDEX IF NOT EXISTS idx_categorias_parent ON luna_financeiro.categorias(parent_id);\n\n-- ========================================\n-- TABELA: Centros de Custo\n-- ========================================\n\nCREATE TABLE IF NOT EXISTS luna_financeiro.centros_custo (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    codigo VARCHAR(20) UNIQUE NOT NULL,\n    nome VARCHAR(100) NOT NULL,\n    descricao TEXT,\n    departamento VARCHAR(100),\n    responsavel VARCHAR(100),\n    ativo BOOLEAN DEFAULT TRUE,\n\n    -- Or√ßamento\n    orcamento_mensal DECIMAL(15, 2),\n\n    -- Sincroniza√ß√£o\n    airtable_record_id VARCHAR(50) UNIQUE,\n\n    -- Auditoria\n    created_at TIMESTAMP DEFAULT NOW(),\n    updated_at TIMESTAMP DEFAULT NOW()\n);\n\nCREATE INDEX IF NOT EXISTS idx_centros_custo_codigo ON luna_financeiro.centros_custo(codigo);\n\n-- ========================================\n-- TABELA: Documentos Financeiros (Principal)\n-- ========================================\n\nCREATE TABLE IF NOT EXISTS luna_financeiro.documentos (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n\n    -- Tipo e Status\n    tipo luna_financeiro.tipo_documento NOT NULL,\n    status luna_financeiro.status_documento DEFAULT 'pendente',\n\n    -- Identifica√ß√£o do Documento\n    numero_documento VARCHAR(100),\n    numero_nf VARCHAR(50),\n    chave_nfe VARCHAR(44),\n\n    -- Datas\n    data_emissao DATE NOT NULL,\n    data_vencimento DATE NOT NULL,\n    data_pagamento DATE,\n    data_competencia DATE,\n\n    -- Valores\n    valor_bruto DECIMAL(15, 2) NOT NULL,\n    valor_desconto DECIMAL(15, 2) DEFAULT 0,\n    valor_juros DECIMAL(15, 2) DEFAULT 0,\n    valor_multa DECIMAL(15, 2) DEFAULT 0,\n    valor_liquido DECIMAL(15, 2) GENERATED ALWAYS AS (\n        valor_bruto - valor_desconto + valor_juros + valor_multa\n    ) STORED,\n    moeda VARCHAR(3) DEFAULT 'BRL',\n\n    -- Relacionamentos\n    entidade_id UUID REFERENCES luna_financeiro.entidades(id),\n    categoria_id UUID REFERENCES luna_financeiro.categorias(id),\n    centro_custo_id UUID REFERENCES luna_financeiro.centros_custo(id),\n\n    -- Descri√ß√£o\n    descricao TEXT NOT NULL,\n    observacoes TEXT,\n\n    -- Pagamento\n    tipo_pagamento luna_financeiro.tipo_pagamento,\n    forma_pagamento luna_financeiro.forma_pagamento,\n\n    -- Arquivos\n    arquivo_url TEXT,\n    arquivo_google_drive_id VARCHAR(100),\n    arquivo_nome VARCHAR(255),\n    arquivo_mime_type VARCHAR(100),\n\n    -- OCR e IA\n    ocr_confianca DECIMAL(3, 2),\n    ocr_processado_em TIMESTAMP,\n    ia_categorizado BOOLEAN DEFAULT FALSE,\n    ia_validado BOOLEAN DEFAULT FALSE,\n\n    -- Recorr√™ncia\n    recorrente BOOLEAN DEFAULT FALSE,\n    documento_pai_id UUID REFERENCES luna_financeiro.documentos(id),\n\n    -- Aprova√ß√£o\n    aprovado_por VARCHAR(100),\n    aprovado_em TIMESTAMP,\n    rejeitado_por VARCHAR(100),\n    rejeitado_em TIMESTAMP,\n    motivo_rejeicao TEXT,\n\n    -- Concilia√ß√£o Banc√°ria\n    conciliado BOOLEAN DEFAULT FALSE,\n    conciliado_em TIMESTAMP,\n    transacao_bancaria_id VARCHAR(100),\n\n    -- Sincroniza√ß√£o Airtable\n    airtable_record_id VARCHAR(50) UNIQUE,\n    ultima_sincronizacao TIMESTAMP,\n\n    -- Auditoria\n    created_at TIMESTAMP DEFAULT NOW(),\n    updated_at TIMESTAMP DEFAULT NOW(),\n    created_by VARCHAR(100),\n    updated_by VARCHAR(100),\n\n    -- Constraints\n    CONSTRAINT chk_valor_positivo CHECK (valor_bruto > 0),\n    CONSTRAINT chk_datas CHECK (data_vencimento >= data_emissao),\n    CONSTRAINT chk_ocr_confianca CHECK (ocr_confianca IS NULL OR (ocr_confianca >= 0 AND ocr_confianca <= 1))\n);\n\n-- √çndices para performance\nCREATE INDEX IF NOT EXISTS idx_documentos_tipo ON luna_financeiro.documentos(tipo);\nCREATE INDEX IF NOT EXISTS idx_documentos_status ON luna_financeiro.documentos(status);\nCREATE INDEX IF NOT EXISTS idx_documentos_data_vencimento ON luna_financeiro.documentos(data_vencimento);\nCREATE INDEX IF NOT EXISTS idx_documentos_data_pagamento ON luna_financeiro.documentos(data_pagamento);\nCREATE INDEX IF NOT EXISTS idx_documentos_entidade ON luna_financeiro.documentos(entidade_id);\nCREATE INDEX IF NOT EXISTS idx_documentos_categoria ON luna_financeiro.documentos(categoria_id);\nCREATE INDEX IF NOT EXISTS idx_documentos_centro_custo ON luna_financeiro.documentos(centro_custo_id);\nCREATE INDEX IF NOT EXISTS idx_documentos_airtable ON luna_financeiro.documentos(airtable_record_id);\nCREATE INDEX IF NOT EXISTS idx_documentos_created_at ON luna_financeiro.documentos(created_at DESC);\nCREATE INDEX IF NOT EXISTS idx_documentos_conciliado ON luna_financeiro.documentos(conciliado) WHERE NOT conciliado;\nCREATE INDEX IF NOT EXISTS idx_documentos_vencidos ON luna_financeiro.documentos(data_vencimento)\n    WHERE status = 'pendente' AND data_vencimento < CURRENT_DATE;\n\n-- Full-text search\nCREATE INDEX IF NOT EXISTS idx_documentos_descricao_fts ON luna_financeiro.documentos USING gin(to_tsvector('portuguese', descricao));\n\n-- ========================================\n-- TABELA: Itens do Documento\n-- ========================================\n\nCREATE TABLE IF NOT EXISTS luna_financeiro.documentos_itens (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    documento_id UUID NOT NULL REFERENCES luna_financeiro.documentos(id) ON DELETE CASCADE,\n\n    sequencia INTEGER NOT NULL,\n    descricao TEXT NOT NULL,\n    quantidade DECIMAL(10, 3) DEFAULT 1,\n    valor_unitario DECIMAL(15, 2) NOT NULL,\n    valor_desconto DECIMAL(15, 2) DEFAULT 0,\n    valor_total DECIMAL(15, 2) GENERATED ALWAYS AS (\n        (quantidade * valor_unitario) - valor_desconto\n    ) STORED,\n\n    -- Produto/Servi√ßo\n    codigo_produto VARCHAR(50),\n    categoria VARCHAR(100),\n\n    -- Auditoria\n    created_at TIMESTAMP DEFAULT NOW(),\n\n    CONSTRAINT chk_quantidade_positiva CHECK (quantidade > 0),\n    CONSTRAINT chk_valor_unitario_positivo CHECK (valor_unitario >= 0)\n);\n\nCREATE INDEX IF NOT EXISTS idx_documentos_itens_documento ON luna_financeiro.documentos_itens(documento_id);\n\n-- ========================================\n-- TABELA: Transa√ß√µes (Audit Log)\n-- ========================================\n\nCREATE TABLE IF NOT EXISTS luna_financeiro.transacoes (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    documento_id UUID REFERENCES luna_financeiro.documentos(id),\n\n    tipo_operacao VARCHAR(50) NOT NULL,\n    tabela VARCHAR(100) NOT NULL,\n\n    -- Dados da mudan√ßa\n    dados_anteriores JSONB,\n    dados_novos JSONB,\n\n    -- Quem fez\n    usuario VARCHAR(100) NOT NULL,\n    ip_address INET,\n    user_agent TEXT,\n\n    -- Quando\n    created_at TIMESTAMP DEFAULT NOW(),\n\n    -- Metadata\n    observacao TEXT\n);\n\nCREATE INDEX IF NOT EXISTS idx_transacoes_documento ON luna_financeiro.transacoes(documento_id);\nCREATE INDEX IF NOT EXISTS idx_transacoes_usuario ON luna_financeiro.transacoes(usuario);\nCREATE INDEX IF NOT EXISTS idx_transacoes_created_at ON luna_financeiro.transacoes(created_at DESC);\nCREATE INDEX IF NOT EXISTS idx_transacoes_tipo ON luna_financeiro.transacoes(tipo_operacao);\n\n-- ========================================\n-- TABELA: Alertas\n-- ========================================\n\nCREATE TABLE IF NOT EXISTS luna_financeiro.alertas (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    documento_id UUID REFERENCES luna_financeiro.documentos(id),\n\n    tipo VARCHAR(50) NOT NULL,\n    severidade VARCHAR(20) DEFAULT 'info',\n\n    titulo VARCHAR(255) NOT NULL,\n    mensagem TEXT NOT NULL,\n\n    -- Destinat√°rios\n    destinatario_email VARCHAR(255),\n    destinatario_whatsapp VARCHAR(20),\n\n    -- Status\n    enviado BOOLEAN DEFAULT FALSE,\n    enviado_em TIMESTAMP,\n    lido BOOLEAN DEFAULT FALSE,\n    lido_em TIMESTAMP,\n\n    -- Agendamento\n    agendar_para TIMESTAMP,\n\n    created_at TIMESTAMP DEFAULT NOW()\n);\n\nCREATE INDEX IF NOT EXISTS idx_alertas_documento ON luna_financeiro.alertas(documento_id);\nCREATE INDEX IF NOT EXISTS idx_alertas_enviado ON luna_financeiro.alertas(enviado) WHERE NOT enviado;\nCREATE INDEX IF NOT EXISTS idx_alertas_severidade ON luna_financeiro.alertas(severidade);\n\n-- ========================================\n-- TABELA: Configura√ß√µes de Aprova√ß√£o\n-- ========================================\n\nCREATE TABLE IF NOT EXISTS luna_financeiro.config_aprovacao (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n\n    valor_minimo DECIMAL(15, 2) NOT NULL,\n    valor_maximo DECIMAL(15, 2),\n\n    aprovador_email VARCHAR(255) NOT NULL,\n    aprovador_nome VARCHAR(100),\n    cargo VARCHAR(100),\n\n    tipo_documento luna_financeiro.tipo_documento,\n\n    ativo BOOLEAN DEFAULT TRUE,\n    ordem INTEGER DEFAULT 1,\n\n    created_at TIMESTAMP DEFAULT NOW(),\n    updated_at TIMESTAMP DEFAULT NOW(),\n\n    CONSTRAINT chk_valores_aprovacao CHECK (valor_maximo IS NULL OR valor_maximo > valor_minimo)\n);\n\nCREATE INDEX IF NOT EXISTS idx_config_aprovacao_valores ON luna_financeiro.config_aprovacao(valor_minimo, valor_maximo);\n\n-- ========================================\n-- TABELA: Concilia√ß√£o Banc√°ria\n-- ========================================\n\nCREATE TABLE IF NOT EXISTS luna_financeiro.conciliacao_bancaria (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n\n    -- Dados da transa√ß√£o banc√°ria\n    data_transacao DATE NOT NULL,\n    descricao_banco TEXT,\n    valor DECIMAL(15, 2) NOT NULL,\n    tipo VARCHAR(20),\n\n    banco VARCHAR(100),\n    agencia VARCHAR(20),\n    conta VARCHAR(30),\n\n    -- Identificadores\n    transacao_id VARCHAR(100) UNIQUE,\n    documento_origem TEXT,\n\n    -- Match com documento\n    documento_id UUID REFERENCES luna_financeiro.documentos(id),\n    match_automatico BOOLEAN DEFAULT FALSE,\n    match_confianca DECIMAL(3, 2),\n\n    -- Status\n    conciliado BOOLEAN DEFAULT FALSE,\n    conciliado_por VARCHAR(100),\n    conciliado_em TIMESTAMP,\n\n    observacoes TEXT,\n\n    created_at TIMESTAMP DEFAULT NOW()\n);\n\nCREATE INDEX IF NOT EXISTS idx_conciliacao_data ON luna_financeiro.conciliacao_bancaria(data_transacao DESC);\nCREATE INDEX IF NOT EXISTS idx_conciliacao_documento ON luna_financeiro.conciliacao_bancaria(documento_id);\nCREATE INDEX IF NOT EXISTS idx_conciliacao_pendente ON luna_financeiro.conciliacao_bancaria(conciliado) WHERE NOT conciliado;\n\n-- ========================================\n-- VIEWS\n-- ========================================\n\nCREATE OR REPLACE VIEW luna_financeiro.vw_documentos_vencidos AS\nSELECT\n    d.*,\n    e.nome as entidade_nome,\n    c.nome as categoria_nome,\n    CURRENT_DATE - d.data_vencimento as dias_vencido\nFROM luna_financeiro.documentos d\nLEFT JOIN luna_financeiro.entidades e ON d.entidade_id = e.id\nLEFT JOIN luna_financeiro.categorias c ON d.categoria_id = c.id\nWHERE d.status = 'pendente'\n  AND d.data_vencimento < CURRENT_DATE;\n\nCREATE OR REPLACE VIEW luna_financeiro.vw_resumo_mensal AS\nSELECT\n    DATE_TRUNC('month', data_vencimento) as mes,\n    tipo,\n    status,\n    COUNT(*) as quantidade,\n    SUM(valor_liquido) as total\nFROM luna_financeiro.documentos\nGROUP BY DATE_TRUNC('month', data_vencimento), tipo, status;\n\nCREATE OR REPLACE VIEW luna_financeiro.vw_fluxo_caixa AS\nWITH recebimentos AS (\n    SELECT data_vencimento, SUM(valor_liquido) as total\n    FROM luna_financeiro.documentos\n    WHERE tipo = 'contas_receber' AND status IN ('pendente', 'aprovado')\n    GROUP BY data_vencimento\n),\npagamentos AS (\n    SELECT data_vencimento, SUM(valor_liquido) as total\n    FROM luna_financeiro.documentos\n    WHERE tipo = 'contas_pagar' AND status IN ('pendente', 'aprovado')\n    GROUP BY data_vencimento\n)\nSELECT\n    COALESCE(r.data_vencimento, p.data_vencimento) as data,\n    COALESCE(r.total, 0) as recebimentos,\n    COALESCE(p.total, 0) as pagamentos,\n    COALESCE(r.total, 0) - COALESCE(p.total, 0) as saldo_dia\nFROM recebimentos r\nFULL OUTER JOIN pagamentos p ON r.data_vencimento = p.data_vencimento\nORDER BY data;\n\n-- ========================================\n-- FUNCTIONS\n-- ========================================\n\nCREATE OR REPLACE FUNCTION luna_financeiro.marcar_pagamentos_atrasados()\nRETURNS INTEGER AS $$\nDECLARE\n    quantidade_atualizada INTEGER;\nBEGIN\n    UPDATE luna_financeiro.documentos\n    SET status = 'vencido',\n        updated_at = NOW()\n    WHERE status = 'pendente'\n      AND data_vencimento < CURRENT_DATE;\n\n    GET DIAGNOSTICS quantidade_atualizada = ROW_COUNT;\n\n    INSERT INTO luna_financeiro.alertas (documento_id, tipo, severidade, titulo, mensagem)\n    SELECT\n        id,\n        'vencimento',\n        'critical',\n        'Documento Vencido',\n        'O documento ' || numero_documento || ' venceu em ' || data_vencimento\n    FROM luna_financeiro.documentos\n    WHERE status = 'vencido'\n      AND NOT EXISTS (\n          SELECT 1 FROM luna_financeiro.alertas a\n          WHERE a.documento_id = documentos.id\n            AND a.tipo = 'vencimento'\n      );\n\n    RETURN quantidade_atualizada;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE OR REPLACE FUNCTION luna_financeiro.update_timestamp()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = NOW();\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE OR REPLACE FUNCTION luna_financeiro.registrar_auditoria()\nRETURNS TRIGGER AS $$\nDECLARE\n    tipo_op VARCHAR(50);\n    usuario_atual VARCHAR(100);\nBEGIN\n    IF TG_OP = 'INSERT' THEN\n        tipo_op := 'INSERT';\n    ELSIF TG_OP = 'UPDATE' THEN\n        tipo_op := 'UPDATE';\n    ELSIF TG_OP = 'DELETE' THEN\n        tipo_op := 'DELETE';\n    END IF;\n\n    usuario_atual := COALESCE(current_setting('app.current_user', TRUE), 'sistema');\n\n    IF TG_OP = 'DELETE' THEN\n        INSERT INTO luna_financeiro.transacoes (\n            documento_id, tipo_operacao, tabela, dados_anteriores, usuario, created_at\n        ) VALUES (\n            OLD.id, tipo_op, TG_TABLE_NAME, row_to_json(OLD), usuario_atual, NOW()\n        );\n        RETURN OLD;\n    ELSE\n        INSERT INTO luna_financeiro.transacoes (\n            documento_id, tipo_operacao, tabela, dados_anteriores, dados_novos, usuario, created_at\n        ) VALUES (\n            NEW.id, tipo_op, TG_TABLE_NAME,\n            CASE WHEN TG_OP = 'UPDATE' THEN row_to_json(OLD) ELSE NULL END,\n            row_to_json(NEW), usuario_atual, NOW()\n        );\n        RETURN NEW;\n    END IF;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- ========================================\n-- TRIGGERS\n-- ========================================\n\nDROP TRIGGER IF EXISTS trg_entidades_update_timestamp ON luna_financeiro.entidades;\nCREATE TRIGGER trg_entidades_update_timestamp\n    BEFORE UPDATE ON luna_financeiro.entidades\n    FOR EACH ROW\n    EXECUTE FUNCTION luna_financeiro.update_timestamp();\n\nDROP TRIGGER IF EXISTS trg_documentos_update_timestamp ON luna_financeiro.documentos;\nCREATE TRIGGER trg_documentos_update_timestamp\n    BEFORE UPDATE ON luna_financeiro.documentos\n    FOR EACH ROW\n    EXECUTE FUNCTION luna_financeiro.update_timestamp();\n\nDROP TRIGGER IF EXISTS trg_documentos_auditoria ON luna_financeiro.documentos;\nCREATE TRIGGER trg_documentos_auditoria\n    AFTER INSERT OR UPDATE OR DELETE ON luna_financeiro.documentos\n    FOR EACH ROW\n    EXECUTE FUNCTION luna_financeiro.registrar_auditoria();\n\nDROP TRIGGER IF EXISTS trg_entidades_auditoria ON luna_financeiro.entidades;\nCREATE TRIGGER trg_entidades_auditoria\n    AFTER INSERT OR UPDATE OR DELETE ON luna_financeiro.entidades\n    FOR EACH ROW\n    EXECUTE FUNCTION luna_financeiro.registrar_auditoria();\n\n-- ========================================\n-- SEED DATA\n-- ========================================\n\nINSERT INTO luna_financeiro.categorias (nome, descricao, tipo, cor) VALUES\n('Aluguel', 'Pagamento de aluguel', 'contas_pagar', '#FF6B6B'),\n('Sal√°rios', 'Folha de pagamento', 'contas_pagar', '#4ECDC4'),\n('Impostos', 'Impostos e taxas', 'contas_pagar', '#95E1D3'),\n('Marketing', 'Despesas com marketing', 'contas_pagar', '#F38181'),\n('TI e Software', 'Sistemas e tecnologia', 'contas_pagar', '#AA96DA'),\n('Fornecedores', 'Compras de fornecedores', 'contas_pagar', '#FCBAD3'),\n('Utilidades', 'Energia, √°gua, internet', 'contas_pagar', '#A8D8EA'),\n('Despesas Gerais', 'Outras despesas', 'contas_pagar', '#E8B4B8')\nON CONFLICT (nome) DO NOTHING;\n\nINSERT INTO luna_financeiro.categorias (nome, descricao, tipo, cor) VALUES\n('Vendas de Produtos', 'Receita com vendas', 'contas_receber', '#90EE90'),\n('Presta√ß√£o de Servi√ßos', 'Receita com servi√ßos', 'contas_receber', '#87CEEB'),\n('Assinaturas', 'Receitas recorrentes', 'contas_receber', '#DDA0DD'),\n('Outras Receitas', 'Receitas diversas', 'contas_receber', '#F0E68C')\nON CONFLICT (nome) DO NOTHING;\n\nINSERT INTO luna_financeiro.config_aprovacao (valor_minimo, valor_maximo, aprovador_email, cargo, ordem) VALUES\n(0, 1000, 'financeiro@mottivme.com.br', 'Autom√°tico', 1),\n(1000, 5000, 'gerente@mottivme.com.br', 'Gerente Financeiro', 2),\n(5000, NULL, 'diretoria@mottivme.com.br', 'Diretoria', 3)\nON CONFLICT DO NOTHING;\n\n-- ========================================\n-- PERMISSIONS\n-- ========================================\n\nGRANT USAGE ON SCHEMA luna_financeiro TO PUBLIC;\nGRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA luna_financeiro TO PUBLIC;\nGRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA luna_financeiro TO PUBLIC;\nGRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA luna_financeiro TO PUBLIC;\n\n-- ========================================\n-- COMMENTS\n-- ========================================\n\nCOMMENT ON SCHEMA luna_financeiro IS 'Schema principal do sistema financeiro Luna';\nCOMMENT ON TABLE luna_financeiro.documentos IS 'Tabela principal de documentos financeiros';\nCOMMENT ON TABLE luna_financeiro.transacoes IS 'Log imut√°vel de auditoria - NUNCA deletar';\nCOMMENT ON COLUMN luna_financeiro.documentos.airtable_record_id IS 'ID do registro sincronizado no Airtable';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        860,
        340
      ],
      "id": "setup-luna-database",
      "name": "üóÑÔ∏è Criar Schema Luna Financeiro",
      "credentials": {
        "postgres": {
          "id": "SEU_ID_CREDENCIAL_SUPABASE",
          "name": "Supabase Luna Financeiro"
        }
      }
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={\n  \"status\": \"success\",\n  \"message\": \"‚úÖ Database Luna Financeiro criado com sucesso!\",\n  \"timestamp\": \"{{ $now.toISO() }}\",\n  \"details\": {\n    \"schema\": \"luna_financeiro\",\n    \"tabelas_criadas\": [\n      \"entidades\",\n      \"categorias\",\n      \"centros_custo\",\n      \"documentos\",\n      \"documentos_itens\",\n      \"transacoes\",\n      \"alertas\",\n      \"config_aprovacao\",\n      \"conciliacao_bancaria\"\n    ],\n    \"views_criadas\": [\n      \"vw_documentos_vencidos\",\n      \"vw_resumo_mensal\",\n      \"vw_fluxo_caixa\"\n    ],\n    \"functions_criadas\": [\n      \"marcar_pagamentos_atrasados()\",\n      \"update_timestamp()\",\n      \"registrar_auditoria()\"\n    ],\n    \"triggers_criados\": 4,\n    \"categorias_seed\": 12,\n    \"config_aprovacao_seed\": 3\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1080,
        340
      ],
      "id": "format-success-response",
      "name": "‚úÖ Formatear Resposta"
    }
  ],
  "connections": {
    "üóÑÔ∏è Criar Schema Luna Financeiro": {
      "main": [
        [
          {
            "node": "‚úÖ Formatear Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-16T12:00:00.000Z",
  "versionId": "1"
}
